import os
import re
import requests
import base64
from pathlib import Path

api_key = "sk-or-v1"

def process_problems(api_key):
    base_dir = "/home/alex/Downloads/ideas/ogemath/"
    codes = """
1.1 Натуральные и целые числа. Признаки делимости
1.2 Обыкновенные/десятичные дроби, проценты
1.3 Рациональные числа и операции
1.4 Действительные числа и операции
1.5 Приближённые вычисления и округление
2.1 Буквенные выражения
2.2 Степени и их свойства
2.3 Многочлены
2.4 Алгебраические дроби
2.5 Арифметические корни
3.1 Уравнения и системы
3.2 Неравенства и системы
3.3 Текстовые задачи
4.1 Последовательности
4.2 Прогрессии и сложные проценты
5.1 Свойства и графики функций
6.1 Координатная прямая
6.2 Декартовы координаты
7.1 Геометрические фигуры
7.2 Треугольники
7.3 Многоугольники
7.4 Окружность и круг
7.5 Измерения
7.6 Векторы
8.1 Описательная статистика
8.2 Вероятность
8.3 Комбинаторика
8.4 Множества
8.5 Графы
"""
    difficulty_def = """
Определения уровней сложности:
Уровень 1 (Простая):
Требует 1-2 прямолинейных шага для решения.
Задействует базовые арифметические операции (сложение, вычитание, умножение, деление) или простейшие алгебраические преобразования.
Предполагает прямое применение одной общеизвестной формулы или концепции.
Формулировка задачи ясная, без сложной терминологии или избыточной информации.
Пример: "Найдите значение (\\left(\\frac{5}{22}-\\frac{8}{11}\\right) \\cdot \\frac{11}{5})"

Уровень 2 (Более сложная чем 1):
Может потребовать 2-3 шага для решения.
Задействует несколько более сложные концепции или комбинацию простых (например, основы геометрии, решение простых линейных уравнений, понимание процентов).
Может требовать внимательного прочтения для извлечения необходимой информации из короткой текстовой задачи.
Применение одной-двух формул или одной формулы с некоторыми преобразованиями.
Пример: "Родительский комитет закупил 25 пазлов... Найдите вероятность того, что Володе достанется пазл с машиной."

Уровень 3 (Более сложная чем 2):
Требует выполнения нескольких шагов (обычно 3-5).
Задействует понимание и применение умеренно сложных концепций (например, системы уравнений, квадратные уравнения, свойства геометрических фигур, многоэтапные текстовые задачи).
Может включать интерпретацию графиков или диаграмм.
Требует определенной последовательности операций или применения нескольких формул.
Может содержать некоторую избыточную информацию, которую необходимо отфильтровать.
Пример: Серия из 5 взаимосвязанных задач о поездке Насти . Отдельные подзадачи могут быть Уровня 2 или 3, но весь комплекс, требующий понимания сценария и выполнения различных расчетов, в целом соответствует Уровню 3. Либо: "Упростите выражение (\\left(\\frac{n+2}{n^{2}-n-6}-\\frac{n}{n^{2}-6 n+9}\\right) \\cdot(2 n-6)^{2})."

Уровень 4 (Более сложная чем 3):
Требует значительного количества шагов или сложной цепи рассуждений.
Задействует продвинутые для стандартного школьного уровня концепции (например, более сложная теория вероятностей, продвинутая алгебра, пространственное мышление в геометрии, нестандартные подходы к решению).
Часто включает многоэтапные текстовые задачи со значительным объемом контекстуальной информации, которую необходимо проанализировать и математически смоделировать.
Может требовать интуиции или распознавания менее очевидной закономерности или "ключа" к решению.
Может включать доказательства или обоснования, требующие твердого понимания основополагающих принципов.
Пример: "Основания трапеции относятся как (1: 3). Через точку пересечения диагоналей проведена прямая, параллельная основаниям. В каком отношении эта прямая делит площадь трапеции?"

Уровень 5 (Самая сложная):
Требует глубокого концептуального понимания и изощренных стратегий решения проблем.
Часто включает абстрактные рассуждения, доказательства нетривиальных теорем или объединение концепций из различных областей математики.
Может требовать творческого мышления и поиска новых подходов.
Задачи обычно объемные, включают множество зависимых частей или требуют обширных вычислений и проверок.
Могут быть задачами олимпиадного уровня или требующими математических знаний университетского уровня.
Пример: "В остроугольном треугольнике (A B C) точки (A, C), центр описанной окружности (O) и центр вписанной окружности (I) лежат на одной окружности. Докажите, что угол (A B C) равен (60^{\\circ})."
"""

    for n in range(3, 4): #range(1,2) means n is 1
        # 1. Подготовка директорий
        problem_dir = Path(f"{base_dir}fipi_training_exams_from_math100_latex/{n}/")
        solution_dir = Path(f"{base_dir}fipi_training_exams_from_math100_solutions/{n}/")
        solution_dir.mkdir(parents=True, exist_ok=True)
        # 2. Обработка файлов
        for file in problem_dir.glob("*.txt"):
            with open(file, 'r', encoding='utf-8') as f:
                content = f.read()
            #if file.stem != 'problem_25':
            #    continue
            # Извлечение данных
            problem_text = re.search(r'problem_text:\n(.*?)\nanswer:', content, re.DOTALL).group(1).strip()
            if file.stem == 'problem_2' or file.stem == 'problem_3' or file.stem == 'problem_4' or file.stem == 'problem_5':
                problem_text = r'''Алексей Юрьевич решил построить на дачном участке теплицу длиной $N P=5,5$ м. Для этого он сделал прямоугольный фундамент. Для каркаса теплицы Алексей Юрьевич заказывает металлические дуги в форме полуокружностей длиной 5,3 м каждая и плёнку для обтяжки. В передней стенке планируется вход, показанный на рисунке прямоугольником $A C D B$. Точки $A$ и $B$ - середины отрезков МО и $O N$ соответственно.

\includegraphics[max width=\textwidth, center]{2025_05_06_53837cfe8f639be0a47eg-1}
''' + " " + problem_text

            answer = re.search(r'answer:\s*(.*)', content).group(1).strip()

            # 3. Поиск изображений
            images = []
            image_matches = re.finditer(r'\\includegraphics.*?\{(.*?)\}', problem_text)
            for match in image_matches:
                image_file = match.group(1)
                image_path = f"{base_dir}fipi_training_exams_from_math100_mathpix_UNzip/{n}/images/{image_file}.jpg"
                
                if image_path:
                    with open(image_path, "rb") as image_file:
                        encoded_image = base64.b64encode(image_file.read()).decode("utf-8")
                        images.append({
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/png;base64,{encoded_image}"
                            }
                        })

            # 4. Формирование промпта
            messages = [
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": f"""Ты репетитор по математике. Реши задачу:
                            
                            problem_text: {problem_text}
                                                        
                            Требования:
                            1. Решение на русском в LaTeX без преамбулы. Решение должно быть коротким, понятным и должно быть составлено как последовательность ключевых шагов решения с прописанной явно нумерацией "Шаг 1", "Шаг 2" и так далее.
                            2. Геометрию решать без применения векторов. Если окончательный ответ это дробь, переведи ее в десятичную дробь.
                            3. Найди единственный код темы, который лучше всего соответствует задаче и дай ответ в виде соответствующего номера: {codes}
                            4. Установи уровень сложности и дай ответ в виде соответствующего числа: {difficulty_def}
                            5. Возьми написанное решение и, не изменяя сути решения, перепиши каждый шаг решения максимально понятно для школьника слабой подготовки, объясняй все свойства, определения, теоремы, концепции, которые использовались в данном шаге.
                            6. Для каждого шага решения из пункта 1 найди наиболее релевантные навыки из следующего списка. Указывай только номер навыка из списка.
                            Список навыков начало:
                            1. Натуральные и целые числа
                            2. Научная форма числа
                            3. Делимость чисел
                            4. Признаки делимости на 2, 3, 5, 9, 10
                            5. Нахождение НОД и НОК
                            6. Обыкновенные и десятичные дроби
                            7. Нахождение доли от числа
                            8. Вычисление процентов
                            9. Повышение/понижение на процент
                            10. Бесконечные периодические дроби
                            11. Определение рациональных чисел
                            12. Расположение на координатной прямой
                            13. Сравнение и упорядочивание рациональных чисел
                            14. Преобразование дробей
                            15. Арифметические действия с  обыкновенными дробями
                            16. Арифметические действия с десятичными дробями
                            17. Раскрытие скобок, распределительное свойство
                            18. Классификация действительных чисел
                            19. Приближённое значение корня числа
                            20. Арифметические действия с рациональными числами
                            21. Понятие точности и погрешности
                            22. Округление чисел
                            23. Приближённые вычисления
                            24. Чтение и анализ графических схем: Графики
                            25. Чтение и анализ графических схем: Диаграммы 
                            26. Чтение и анализ графических схем: План помещения
                            27. Чтение и анализ графических схем: Схема маршрута / карта
                            28. Чтение и анализ графических схем: Таблицы и расписания
                            29. Чтение и анализ графических схем: Тарифные планы
                            30. Чтение и анализ графических схем: Линейка, шкала, измерения
                            31. Чтение и анализ графических схем: Графики движения
                            32. Прикладная геометрия: Путешествия
                            33. Прикладная геометрия: Квартиры и садовые участки 
                            34. Прикладная геометрия: Шины, теплицы, бумага, печки 
                            35. Выражения с переменными
                            36. Подстановка значений
                            37. Упрощение выражений
                            38. Раскрытие скобок
                            39. Определение степени с целым показателем
                            40. Определение степени с рациональным показателем (Корни)
                            41. Умножение и деление степеней при одном основании
                            42. Возведение степени в степень
                            43. Степень произведения и частного 
                            44. Отрицательные степени
                            45. Определение одночлена и многочлена
                            46. Приведение подобных членов многочленов
                            47. Сложение и вычитание многочленов
                            48. Умножение многочленов
                            49. Разложение многочленов на множители (факторизация)
                            50. Определение и сокращение алгебраических дробей
                            51. Основное свойство алгебраической дроби
                            52. Арифметические действия с алгебраическими дробями
                            53. Преобразование выражений с алгебраическими дробями
                            54. Определение корней
                            55. Свойства корней
                            56. Арифметика с корнями
                            57. Рационализация знаменателя
                            58. Решение линейных уравнений
                            59. Решение уравнений с дробями и скобками
                            60. Решение квадратных уравнений
                            61. Решение систем линейных уравнений
                            62. Рациональные уравнения
                            63. Решение линейных неравенств
                            64. Графическое представление решений
                            65. Решение систем неравенств
                            66. Квадратные неравенства 
                            67. Рациональные неравенства
                            68. Метод интервалов
                            69. Перевод текставой задачи в уравнение
                            70. Текстовые задачи: Задачи на проценты, сплавы и смеси 
                            71. Текстовые задачи: Движение по прямой
                            72. Текстовые задачи: Задачи на движение по воде 
                            73. Текстовые задачи: Задачи на совместную работу 
                            74. Текстовые задачи: Задачи про бизнес
                            75. Разные текстовые задачи
                            76. Запись последовательностей
                            77. Способы задания последовательностей
                            78. Правило n-го члена последовательностей
                            79. Определение следующего члена последовательностей
                            80. Арифметическая прогрессия
                            81. Сумма первых n членов  АП
                            82. Определение разности и первого члена  АП
                            83. Текстовые задачи на АП
                            84. Геометрическая прогрессия
                            85. Сумма первых n членов  ГП
                            86. Определение разности и первого члена  ГП
                            87. Текстовые задачи на ГП
                            88. Сложные проценты
                            89. Определение функции
                            90. Область определения и множество значений
                            91. Нули функции
                            92. Построение графиков функции
                            93. Линейные функции
                            94. Квадратичные функции (Параболы)
                            95. Гиперболы 
                            96. Промежутки знакопостоянства функции
                            97. Промежутки монотонности функции
                            98. Чтение графиков функции
                            99. Максимумы и минимумы функции
                            100. Наибольшее и наименьшее значение функции на промежутке
                            101. Кусочно-непрерывные функции
                            102. Растяжения и сдвиги
                            103. Расположение чисел на прямой (Отметка точек)
                            104. Расстояние между точками на координатной прямой
                            105. Модули
                            106. Интервалы
                            107. Неравенства
                            108. Сравнение и упорядочивание чисел на координатной прямой
                            109. Выбор верного или неверного утверждения о числах на координатной прямой
                            110. Построение точек по координатам на плоскости
                            111. Расстояние между точками на плоскости
                            112. Точки, прямые, отрезки, лучи
                            113. Углы и их виды
                            114. Измерение углов
                            115. Параллельные и перпендикулярные прямые
                            116. Серединный перпендикуляр
                            117. Виды треугольников
                            118. Элементы треугольника (сторона, угол, высота, медиана, биссектриса)
                            119. Свойства углов треугольника
                            120. Признаки равенства треугольников
                            121. Признаки подобия треугольников
                            122. Неравенство треугольника
                            123. Прямоугольный треугольник: Теорема Пифагора
                            124. Прямоугольный треугольник:  Тригонометрия
                            125. Виды многоугольников
                            126. Элементы многоугольников
                            127. Углы многоугольников
                            128. Правильные многоугольники
                            129. Деление многоугольников на треугольники
                            130. Прямоугольник
                            131. Ромб
                            132. Квадрат
                            133. Параллелограмм
                            134. Трапеция
                            135. Элементы окружности и круга (Касательная, хорда, секущая, радиус)
                            136. Центральные и вписанные углы
                            137. Вписанные  фигуры
                            138. Описанные фигуры
                            139. Длина отрезка, длина ломаной
                            140. Периметр многоугольника
                            141. Расстояние от точки до прямой
                            142. Длина окружности
                            143. Градусная мера угла
                            144. Ссоответствие между величиной угла и длиной дуги окружности
                            145. Площадь и её свойства
                            146. Площадь прямоугольника
                            147. Площадь параллелограмма
                            148. Площадь трапеции
                            149. Площадь треугольника
                            150. Площадь круга и его частей 
                            151. Пропорциональное деление площади
                            152. Формулы объёма прямоугольного параллелепипеда, куба, шара
                            153. Фигуры на квадратной решётке
                            154. Направление и длина вектора
                            155. Координаты вектора
                            156. Сложение и вычитание векторов
                            157. Умножение вектора на число
                            158. Анализ геометрических высказываний
                            159. Работа с чертежами
                            160. Задачи на доказательство
                            161. Геометрические задачи повышенной сложности
                            162. Сбор данных
                            163. Таблицы и диаграммы в статистике
                            164. Среднее арифметическое
                            165. Мода и медиана
                            166. Определение событий
                            167. Нахождение вероятности простых событий
                            168. Применение формул вероятности
                            169. Перестановки
                            170. Размещения
                            171. Сочетания
                            172. Подсчёт с использованием формул комбинаторики
                            173. Операции с множествами
                            174. Диаграммы Эйлера–Венна
                            175. Вершины и рёбра
                            176. Связность графа
                            177. Поиск путей
                            178. Решение прикладных задач с графами
                            179. Calculator skills
                            180. Time management
                            Список навыков конец.
                            Формат ответа:
                            solution_text: [решение, как указано в пункте 1 выше]
                            code: [код в виде числа]
                            difficulty: [уровень сложности в виде числа]
                            solutiontextexpanded: [максимально подробное решение, как указанов пункте 5 выше]
                            skills_for_steps: [Список навыков для каждого шага, например: Шаг 1: [Навык 28, Навык 78], Шаг 2: [Навык 11], ...]"""
                        }
                    ] + images
                }
            ]

            # 5. Отправка запроса
            headers = {
                "Authorization": f"Bearer sk-or-v1",
                "Content-Type": "application/json"
            }

            payload = {
                "model": "openai/o4-mini-high",
                "messages": messages,
                "max_tokens": 20000,
                "temperature": 0.7
            }
            #"qwen/qwen2.5-vl-72b-instruct", "temperature": 0.6
            try:
                response = requests.post(
                    "https://openrouter.ai/api/v1/chat/completions",
                    headers=headers,
                    json=payload,
                    timeout=30
                )
                response.raise_for_status()

                solution = response.json()['choices'][0]['message']['content']
                solution_file = solution_dir / f"{n}_{file.stem.split('_')[1]}.txt"
                print(f"Done:  {n}_{file.stem.split('_')[1]}.txt")
                print(images)
                with open(solution_file, 'w', encoding='utf-8') as f:
                    f.write(solution)

            except Exception as e:
                print(f"Ошибка обработки {file}: {str(e)}")
                print(images)

process_problems("sk-or-v1")
